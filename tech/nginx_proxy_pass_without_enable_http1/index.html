<!doctype html><html><head><meta charset=utf-8><title>nginx 反向代理不开启http1.1时的行为探究 // Yuantops&#39; Blog</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:title content="nginx 反向代理不开启http1.1时的行为探究"><meta property=og:description content="nginx 做反向代理服务器，与upstream之间默认使用http1.0协议。借助tcpdump和wireshark,来看看开启http1.1前后的区别。"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content=https://blog.yuantops.com/tech/nginx_proxy_pass_without_enable_http1/><link href rel=alternate type=application/rss+xml title="Yuantops' Blog"><link rel="shortcut icon" href=/favicon.ico><link href=https://blog.yuantops.com/webfonts/ptserif/main.css rel=stylesheet type=text/css><link href=https://blog.yuantops.com/webfonts/source-code-pro/main.css rel=stylesheet type=text/css><link rel=stylesheet href=https://blog.yuantops.com/css/style.css><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="nginx 做反向代理服务器，与upstream之间默认使用http1.0协议。借助tcpdump和wireshark,来看看开启http1.1前后的区别。"><meta name=keywords content=nginx,><meta name=author content=[yuan.tops@gmail.com]><meta name=generator content="Hugo 0.50"></head><body><div id=container><header id=header><div id=header-outer class=outer><div id=header-inner class=inner><a id=main-nav-toggle class=nav-icon href=javascript:;></a><a id=logo class=logo-text href=https://blog.yuantops.com/>Yuantops&#39; Blog</a><nav id=main-nav><a class=main-nav-link href=/archives/>Archives</a>
<a class=main-nav-link href=/about/>About</a>
<a class=main-nav-link href=/index.xml>RSS</a></nav><nav id=sub-nav><div id=search-form-wrap></div></nav></div></div></header><section id=main class=outer><article class="article article-type-post" itemscope itemprop=blogPost><div class=article-inner><header class=article-header><h1 class=article-title itemprop=name>nginx 反向代理不开启http1.1时的行为探究</h1></header><div class=article-meta><a href=/tech/nginx_proxy_pass_without_enable_http1/ class=article-date><time datetime=2021-08-24T00:00:00.000&#43;08:00 itemprop=datePublished>2021-08-24</time></a><div class=post-categories><div class=article-category><a class=article-category-link href=https://blog.yuantops.com//categories/tech>Tech</a></div><div class=article-category>254字, 约2分钟读完</div></div></div><div class=article-entry itemprop=articleBody><p>最近给一个tomcat服务加上nginx代理，陆续遇到一些问题（坑）。</p><p>第一个坑，一个接口直接访问正常，经nginx代理后报104错误(104: Connection reset by peer)。奇葩之处在于，只有特定的接口出现这种错。</p><h2 id=先说解决方案-配置反向代理长链接>先说解决方案：配置反向代理长链接</h2><p>很容易搜到104错误的解决方案.在nginx配置中，加上下面两句:</p><blockquote><p>proxy_http_version 1.1;
proxy_set_header Connection &ldquo;&rdquo;;</p></blockquote><p>加上之后，执行命令 <strong>nginx -s reload</strong> 生效。</p><p>翻看nginx<a href=http://nginx.org/en/docs/http/ngx%5Fhttp%5Fproxy%5Fmodule.html#keepalive>官方文档</a>，这么说:</p><blockquote><p>For HTTP, the proxy_http_version directive should be set to “1.1” and the “Connection” header field should be cleared:
upstream http_backend {
server 127.0.0.1:8080;</p><pre><code>keepalive 16;
</code></pre><p>}</p><p>server {
&hellip;</p><pre><code>location _http_ {
    proxy\_pass &lt;http://http%5Fbackend&gt;;
    proxy\_http\_version 1.1;
    proxy\_set\_header Connection &quot;&quot;;
    ...
}
</code></pre><p>}</p></blockquote><p>到这里，问题已经解决。我们再进一步，看看配置前后的区别。</p><h2 id=tcpdump-抓包>tcpdump 抓包</h2><p>在修改前后，各自抓包。</p><blockquote><p>tcpdump -iensxxx -vvvs0 -l -A &lsquo;tcp port 80 or tcp port 8082&rsquo; -w tcpdump.cap</p></blockquote><h2 id=wireshark分析>wireshark分析</h2><p>将*.cap文件用wireshark 打开.</p><ol><li>在filter里输入 <strong>http.request &amp;&amp; http contains &ldquo;HTTP/1.0&rdquo;</strong> ，过滤出nginx到上游服务的请求.</li><li>随意选中一条记录。右键，&rdquo;追踪流&hellip;&rdquo; -&gt; &ldquo;TCP流&rdquo;。这样，筛选出了TCP会话的所有包记录。</li><li>右键, &ldquo;复制&rdquo; -&gt; &ldquo;摘要为文本&rdquo;，可以将报文导出为文本。</li></ol><p>下面的记录，第一条是异常响应报文，第二条是正常响应报文。</p><blockquote><p>&mdash; not ok tcp.stream eq 75
HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
Content-Type: application/json;charset=UTF-8
Date: Mon, 23 Aug 2021 09:41:57 GMT
Connection: close</p><p>[{&ldquo;xxxxxx&rdquo;:&ldquo;xxxxxxxxxxxxxxx&rdquo;,&ldquo;xxxx&rdquo;:&ldquo;xxx&rdquo;,&ldquo;xxxxxx&rdquo;:&ldquo;xxxxxxxxxxxxx&rdquo;,&ldquo;xxx&rdquo;:xx}]</p><p>&mdash; ok tcp.stream eq 104
HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
Content-Type: application/json;charset=UTF-8
Transfer-Encoding: chunked
Date: Mon, 23 Aug 2021 09:45:33 GMT</p><p>4d
[{&ldquo;xxxxxx&rdquo;:&ldquo;xxxxxxxxxxxxxxx&rdquo;,&ldquo;xxxx&rdquo;:&ldquo;xxx&rdquo;,&ldquo;xxxxxx&rdquo;:&ldquo;xxxxxxxxxxxxx&rdquo;,&ldquo;xxx&rdquo;:xx}]</p></blockquote><p>可以观察到:</p><ol><li>头部不一致。<ul><li>异常报文多了 &ldquo;Connection: close&rdquo; ，含义是数据返回后将关闭连接。</li><li>正常报文多了 &ldquo;Transfer-Encoding: chunked&rdquo;，含义是返回的数据采取“分块编码”, 也就是分多块返回。</li></ul></li><li>body不一致。<ul><li>正常报文在body之前，声明了数据块的大小。</li></ul></li><li>我们使用HTTP1.0发起请求，但返回报文头部居然写着 HTTP/1.1。这是怎么回事??
参考 <a href=https://stackoverflow.com/questions/19461312/why-tomcat-reply-http-1-1-respose-with-an-http-1-0-request>https://stackoverflow.com/questions/19461312/why-tomcat-reply-http-1-1-respose-with-an-http-1-0-request</a>, 返回头的HTTP版本号只是一个声明，告知调用方服务端所支持的最高HTTP版本。</li></ol><blockquote><p>This Connector supports all of the required features of the HTTP/1.1 protocol, as described in RFC 2616, including persistent connections, pipelining, expectations and chunked encoding. If the client (typically a browser) supports only HTTP/1.0, the Connector will gracefully fall back to supporting this protocol as well. No special configuration is required to enable this support. The Connector also supports HTTP/1.0 keep-alive.</p><p>RFC 2616 requires that HTTP servers always begin their responses with the highest HTTP version that they claim to support. Therefore, this Connector will always return HTTP/1.1 at the beginning of its responses.</p></blockquote></div><div class=article-toc style=display:none><h3>Contents</h3><nav id=TableOfContents><ul><li><ul><li><a href=#先说解决方案-配置反向代理长链接>先说解决方案：配置反向代理长链接</a></li><li><a href=#tcpdump-抓包>tcpdump 抓包</a></li><li><a href=#wireshark分析>wireshark分析</a></li></ul></li></ul></nav></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.slim.min.js integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc=" crossorigin=anonymous></script><script>(function(){var $toc=$('#TableOfContents');if($toc.length>0){var $window=$(window);function onScroll(){var currentScroll=$window.scrollTop();var h=$('.article-entry h1, .article-entry h2, .article-entry h3, .article-entry h4, .article-entry h5, .article-entry h6');var id="";h.each(function(i,e){e=$(e);if(e.offset().top-10<=currentScroll){id=e.attr('id');}});var active=$toc.find('a.active');if(active.length==1&&active.eq(0).attr('href')=='#'+id)return true;active.each(function(i,e){$(e).removeClass('active').siblings('ul').hide();});$toc.find('a[href="#'+id+'"]').parentsUntil('#TableOfContents').each(function(i,e){$(e).children('a').addClass('active').siblings('ul').show();});}
$window.on('scroll',onScroll);$(document).ready(function(){$toc.find('a').parent('li').find('ul').hide();onScroll();document.getElementsByClassName('article-toc')[0].style.display='';});}})();</script><footer class=article-footer><ul class=article-tag-list><li class=article-tag-list-item><a class=article-tag-list-link href=https://blog.yuantops.com//tags/linux>Linux</a></li></ul></footer></div><nav id=article-nav><a href=/tech/linux_tcp_time_wait_tuning/ id=article-nav-newer class=article-nav-link-wrap><div class=article-nav-title><span>&lt;</span>&nbsp;
TCP TIME_WAIT 连接太多</div></a><a href=/tech/thoughts_on_distributed_tracing_system/ id=article-nav-older class=article-nav-link-wrap><div class=article-nav-title>分布式追踪系统之我见&nbsp;<span>&gt;</span></div></a></nav></article></section><footer id=footer><div class=outer><div id=footer-info class=inner>&copy; 2012-2021 @yuantops&nbsp;</br>Proudly powered by <a href=https://gohugo.io target=_blank>Hugo</a> with theme <a href=https://github.com/carsonip/hugo-theme-minos>Minos</a></div></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-57420914-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin=anonymous></script><script>hljs.initHighlightingOnLoad();</script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css integrity=sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0 crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js integrity=sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1 crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js integrity="sha256-ExtbCSBuYA7kq1Pz362ibde9nnsHYPt6JxuxYeZbU+c=" crossorigin=anonymous></script><script>renderMathInElement(document.body);</script><script>document.getElementById('main-nav-toggle').addEventListener('click',function(){var header=document.getElementById('header');if(header.classList.contains('mobile-on')){header.classList.remove('mobile-on');}else{header.classList.add('mobile-on');}});</script></footer></div></body></html>