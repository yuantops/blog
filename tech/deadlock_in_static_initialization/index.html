<!doctype html><html><head><meta charset=utf-8><title>偶遇 static 初始化死锁 // Yuantops&#39; Blog</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:title content="偶遇 static 初始化死锁"><meta property=og:description content=死锁有很多，在类初始化流程遭遇死锁比较少见。这里提供一份示例代码，恰好复现这种死锁。><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content=https://blog.yuantops.com/tech/deadlock_in_static_initialization/><link href rel=alternate type=application/rss+xml title="Yuantops' Blog"><link rel="shortcut icon" href=/favicon.ico><link href=https://blog.yuantops.com/webfonts/ptserif/main.css rel=stylesheet type=text/css><link href=https://blog.yuantops.com/webfonts/source-code-pro/main.css rel=stylesheet type=text/css><link rel=stylesheet href=https://blog.yuantops.com/css/style.css><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content=死锁有很多，在类初始化流程遭遇死锁比较少见。这里提供一份示例代码，恰好复现这种死锁。><meta name=keywords content=java,deadlock,><meta name=author content=[yuan.tops@gmail.com]><meta name=generator content="Hugo 0.50"></head><body><div id=container><header id=header><div id=header-outer class=outer><div id=header-inner class=inner><a id=main-nav-toggle class=nav-icon href=javascript:;></a><a id=logo class=logo-text href=https://blog.yuantops.com/>Yuantops&#39; Blog</a><nav id=main-nav><a class=main-nav-link href=/archives/>Archives</a>
<a class=main-nav-link href=/about/>About</a>
<a class=main-nav-link href=/index.xml>RSS</a></nav><nav id=sub-nav><div id=search-form-wrap></div></nav></div></div></header><section id=main class=outer><article class="article article-type-post" itemscope itemprop=blogPost><div class=article-inner><header class=article-header><h1 class=article-title itemprop=name>偶遇 static 初始化死锁</h1></header><div class=article-meta><a href=/tech/deadlock_in_static_initialization/ class=article-date><time datetime=2021-10-29T18:01:44.000&#43;08:00 itemprop=datePublished>2021-10-29</time></a><div class=post-categories><div class=article-category><a class=article-category-link href=https://blog.yuantops.com//categories/tech>Tech</a></div><div class=article-category>232字, 约2分钟读完</div></div></div><div class=article-entry itemprop=articleBody><p>最近开发新系统，用到了内存数据库 H2 web 服务. 上线时，遇到问题：服务卡住，不报错，也起不来。</p><p>用 `jstack` 查看栈信息，main thread 状态为 RUNNABLE，另外一个线程 `H2 Console Server` 状态也为 RUNNABLE。仔细观察， <code>main</code> 栈包含一段可疑信息: <code>-locked &lt;xxxx&gt; (a java.lang.Class for org.h2.Driver)</code> ，疑似线程被锁。</p><p>有两个诡异之处：1. 服务启动阻塞具有偶然性，有的机器（特别是性能比较差的机器）大概率不会卡。2. 虽然阻塞了，但此时 h2 数据库 web console 已经成功起来了。WHY??</p><p>作为应急措施，在启动 H2 web 之后，立马让当前线程停一会儿(<code>Thread.sleep(500)</code>)，服务顺利启动。接下来，是我慢慢和它死磕的过程。</p><h2 id=调试>调试</h2><p>单步调试法 + 日志大法。</p><p>调试小技巧：如果类在依赖的 jar 里，又想在这个类里打日志，只需按它的包结构在 IDE 里对应建立目录层级，再把源码拷贝进去就好了。</p><p>最后发现了问题：在类静态方法加载过程中，形成了死锁。</p><p>下面是摘出来的问题代码:</p><h2 id=问题代码>问题代码</h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> org.h2.Driver<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.h2.tools.Server<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> java.sql.SQLException<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args1<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>

        <span style=color:#66d9ef>int</span> port <span style=color:#f92672>=</span> 9081<span style=color:#f92672>;</span>
        Server webServer <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
        String<span style=color:#f92672>[]</span> args <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;-web,-webAllowOthers,-trace,-webPort,&#34;</span> <span style=color:#f92672>+</span> port<span style=color:#f92672>).</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            webServer <span style=color:#f92672>=</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>h2</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tools</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Server</span><span style=color:#f92672>.</span><span style=color:#a6e22e>createWebServer</span><span style=color:#f92672>(</span>args<span style=color:#f92672>);</span>
            webServer<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SQLException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            String msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;h2 web server create failed&#34;</span><span style=color:#f92672>;</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;[&#34;</span><span style=color:#f92672>+</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()+</span><span style=color:#e6db74>&#34;]尝试加载 driver &#34;</span> <span style=color:#f92672>+</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>());</span>
        Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>32<span style=color:#f92672>);</span>
        Driver driver <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Driver<span style=color:#f92672>();</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!看到我，说明死锁重现失败。多试几次！！！！！！！！！！！！&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span></code></pre></td></tr></table></div></div><h2 id=死锁分析>死锁分析</h2><ol><li>main() 方法运行的线程，为 [main] 线程。</li><li><p>执行到第 14 行，执行 webServer.start() 方法后，第二个线程 [H2 Console Thread] 将被启动(通过单步追踪，可以定位具体代码)。具体流程为:
2.1. 创建 ServerSocket, 开始监听服务端端口
2.2. 新建名为[H2 Console Thread] 的线程，每当服务端口读到了数据，则
2.3. 新分配一个线程，处理数据流。</p></li><li><p>在 2.1 ，为了确认 ServerSocket 成功建立，会尝试与服务端口号建立一个 socket，一旦成功，则认为服务端口已经起来, 并关闭 socket。</p></li><li><p>2.3 中创建的新线程，读到一个空白文件流，抛出 EOF 异常。在异常处理类 <code>DbException.java</code> 中，会加载 DriverManager.java (详见代码)。进入 static {} 后，持有了锁B。同时在 static 方法中，它通过 ServiceLoader 尝试加载所有 Driver，这意味着，它要等待 Driver.java 初始化的锁(锁A)</p></li><li><p>main 线程中，在故意等待了一小段时间(第21行)后，main() 方法继续执行。在第 22 行创建 driver 实例的过程中，进入static {} 方法，持有了 Driver.java 的锁(锁A)。同时，在 static {} 中，尝试 load DriverManager.java，需要等待 DriverManager.java 的锁(锁B)</p></li><li><p>两个线程，彼此等待对方持有的锁。也就形成了死锁。</p></li></ol><h2 id=自问自答-初始化存在锁>自问自答: 初始化存在锁??</h2><p>参考回答: <a href=https://stackoverflow.com/questions/878577/are-java-static-initializers-thread-safe>https://stackoverflow.com/questions/878577/are-java-static-initializers-thread-safe</a></p><p>静态代码块 static {} 是线程安全的，同时只能在一个线程中运行。</p><p>以及回答：<a href=https://stackoverflow.com/questions/55204559/what-happens-when-multiple-threads-ask-for-the-same-class-to-be-loaded-at-same-t>https://stackoverflow.com/questions/55204559/what-happens-when-multiple-threads-ask-for-the-same-class-to-be-loaded-at-same-t</a></p><p>类的初始化，确实存在锁。</p><h2 id=自问自答-为什么-thread-dot-sleep--500--有用>自问自答: 为什么 <code>Thread.sleep(500)</code> 有用?</h2><p>死锁的本质在资源争抢。加上 Java 类加载存在缓存机制，只要让一个线程先执行完，就破解了锁。</p></div><div class=article-toc style=display:none><h3>Contents</h3><nav id=TableOfContents><ul><li><ul><li><a href=#调试>调试</a></li><li><a href=#问题代码>问题代码</a></li><li><a href=#死锁分析>死锁分析</a></li><li><a href=#自问自答-初始化存在锁>自问自答: 初始化存在锁??</a></li><li><a href=#自问自答-为什么-thread-dot-sleep--500--有用>自问自答: 为什么 <code>Thread.sleep(500)</code> 有用?</a></li></ul></li></ul></nav></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.slim.min.js integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc=" crossorigin=anonymous></script><script>(function(){var $toc=$('#TableOfContents');if($toc.length>0){var $window=$(window);function onScroll(){var currentScroll=$window.scrollTop();var h=$('.article-entry h1, .article-entry h2, .article-entry h3, .article-entry h4, .article-entry h5, .article-entry h6');var id="";h.each(function(i,e){e=$(e);if(e.offset().top-10<=currentScroll){id=e.attr('id');}});var active=$toc.find('a.active');if(active.length==1&&active.eq(0).attr('href')=='#'+id)return true;active.each(function(i,e){$(e).removeClass('active').siblings('ul').hide();});$toc.find('a[href="#'+id+'"]').parentsUntil('#TableOfContents').each(function(i,e){$(e).children('a').addClass('active').siblings('ul').show();});}
$window.on('scroll',onScroll);$(document).ready(function(){$toc.find('a').parent('li').find('ul').hide();onScroll();document.getElementsByClassName('article-toc')[0].style.display='';});}})();</script></div><nav id=article-nav><a href=/tech/reinstall-windows-10-for-dual-boot-system/ id=article-nav-older class=article-nav-link-wrap><div class=article-nav-title>最近一次重装系统&nbsp;<span>&gt;</span></div></a></nav></article></section><footer id=footer><div class=outer><div id=footer-info class=inner>&copy; 2012-2021 @yuantops&nbsp;</br>Proudly powered by <a href=https://gohugo.io target=_blank>Hugo</a> with theme <a href=https://github.com/carsonip/hugo-theme-minos>Minos</a></div></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-57420914-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin=anonymous></script><script>hljs.initHighlightingOnLoad();</script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css integrity=sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0 crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js integrity=sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1 crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js integrity="sha256-ExtbCSBuYA7kq1Pz362ibde9nnsHYPt6JxuxYeZbU+c=" crossorigin=anonymous></script><script>renderMathInElement(document.body);</script><script>document.getElementById('main-nav-toggle').addEventListener('click',function(){var header=document.getElementById('header');if(header.classList.contains('mobile-on')){header.classList.remove('mobile-on');}else{header.classList.add('mobile-on');}});</script></footer></div></body></html>